








<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Random Hacks | Getting Home Assistant to Tell Me When to Open the Windows </title>
    <meta name="theme-color" content="#222222"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/popper.min.js"></script>
    <script src="/assets/js/bootstrap4.min.js"></script>
    <script src="/assets/js/header.js"></script>
    <script src="/assets/css/svg-with-js/js/fontawesome-all.js"></script>
    <link href="/assets/css/bootstrap4.min.css" rel="stylesheet">
    <link href="/assets/css/theme.css" rel="stylesheet">
    <link href="/assets/css/syntax.css" rel="stylesheet">
 </head>

<body>

<script type="text/javascript">
    WebFontConfig = {
        google: {
            families: ['Ubuntu::latin']
        }
    };
    (function () {
        var wf = document.createElement('script');
        wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
            '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
        wf.type = 'text/javascript';
        wf.async = 'true';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(wf, s);
    })();


 function InitCopyPaste(){
   const codeBlocks = document.querySelectorAll("div.highlighter-rouge");

   codeBlocks.forEach((codeblock, index) => {
     const code = codeBlocks[index].innerText;
     const copyCodeButton = document.createElement("button");
     copyCodeButton.innerHTML = "COPY";
     copyCodeButton.classList = "btn btn-sm btn-outline-primary";
     // insert a copy button
     copyCodeButton.onclick = function () {
       window.navigator.clipboard.writeText(code);
       copyCodeButton.innerHTML = "COPIED";
       copyCodeButton.classList.add("btn-success");
       copyCodeButton.classList.remove("btn-outline-primary");

       setTimeout(() => {
         copyCodeButton.innerHTML = "COPY";
         copyCodeButton.classList.remove("btn-success");
         copyCodeButton.classList.add("btn-outline-primary");
       }, 2000);
     };
     // make the button
     codeblock.appendChild(copyCodeButton);
   });
 }

 document.addEventListener("DOMContentLoaded", InitCopyPaste);
</script>


<script>
 $(document).ready(function(){

 const headings = document.querySelectorAll('h1[id], h2[id],h3[id]'); // 1
   const linkContent = '<i class="fas fa-link"></i>'; // 2
   for (const heading of headings) { // 3
                                     const space = document.createElement('span');
     space.innerHTML=" ";
     space.className = "header_link_span";
   const linkIcon = document.createElement('a'); // 4
   linkIcon.setAttribute('href', `#${heading.id}`); // 5
   linkIcon.className = "header_link";
   linkIcon.innerHTML = linkContent; // 6
   space.appendChild(linkIcon); // 7
     heading.appendChild(space);
 }
   });
</script>



<nav class="navbar navbar-expand-lg fixed-top navbar-dark">
    <div class="container">
        <a class="navbar-brand offset-md-1" href="/">Random Hacks</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse"
                data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup"
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
          <div class="navbar-nav">
            <a class="nav-item nav-link" href="/">Home</a>
            <a class="nav-item nav-link" href="/about">About</a>
          </div>
        </div>
    </div>
</nav>

    <div class="wrapper">
      <div class="content">
        <div class="container container-center">
          <div class="row">
            <div class="col-md-8 offset-md-1">
              <div class="article">
                <div class="card">
                  <h1><a href="/2022/07/getting-home-assistant-to-tell-me-when-to-open-the-windows/">Getting Home Assistant to Tell Me When to Open the Windows</a></h1>
                  <div class="post-meta">
                    <div class="post-time">
                      <i class="fa fa-calendar-alt"></i>
                      <time>06 Jul 2022</time>
                    </div>
                    <ul>
                      
                        <li><a href="/tag/homeassistant">homeassistant</a></li>
                      
                        <li><a href="/tag/automations">automations</a></li>
                      
                        <li><a href="/tag/blueprint">blueprint</a></li>
                      
                    </ul>
                  </div>
                   <div class="post-content"> 
                     <h1 id="goals">Goals</h1>

<p>My house doesn’t have A/C so I’m primarily dependent on opening the windows to cool down my house. However, I don’t want to open the windows if it’s too hot outside. I also don’t want to have to constantly check the temperature–instead I want Home Assistant to notify me when it’s time to open the windows, or if it’s time to close the windows because it got warmer outside. I call this a “temperature inversion” to sound fancy, so you’ll see that term (or TID for temperature inversion detection) peppered throughout the guide.</p>

<p>To accomplish this, I have four(ish) sensors: an outdoor temperature sensor, an indoor temperature sensor, a window sensor to tell if the window is open or closed, and I also have a sensor that tells me today’s high (because if the high isn’t very hot, I don’t care about the windows being open or not).</p>

<p>The goal is to set the desired state of the windows as follows:</p>
<ul>
  <li>If it’s <strong><em>cooler</em></strong> outside than inside (by some adjustable margin), <strong>and</strong> it’s warmer inside than some threshold, the windows should be open.</li>
  <li>If it’s <strong><em>warmer</em></strong> outside than inside (by some adjustable margin), <strong>and</strong> today’s high is higher than some threshold, the windows should be closed.</li>
  <li>Otherwise, the windows can be in any state.</li>
</ul>

<p>Whenever the windows don’t match their desired state, I get a notification.</p>

<h1 id="setup">Setup</h1>

<p>First, I create a bunch of helpers which will serve as knobs for me to configure things:</p>
<ul>
  <li>An <code class="language-plaintext highlighter-rouge">input_number</code> with entity ID <code class="language-plaintext highlighter-rouge">input_number.temperature_inversion_difference</code>, which allows me to adjust how much warmer or cooler it must be outside to get a notification.</li>
  <li>An <code class="language-plaintext highlighter-rouge">input_number</code> with entity ID <code class="language-plaintext highlighter-rouge">input_number.temperature_inversion_indoor_threshold</code>, which lets me set the threshold for the indoor temperature above which I want to be told to open the windows. (I.e. if it’s already cool inside, I don’t need a notification to tell me to open the windows.)</li>
  <li>An <code class="language-plaintext highlighter-rouge">input_number</code> with entity ID <code class="language-plaintext highlighter-rouge">input_number.temperature_inversion_outdoor_max_high</code>, which lets me set the outdoor high above which I want to be told to close the windows. (I.e. if the high is going to be a comfortable 74°F, then I don’t need a notification telling me to open the windows even if it’s warmer outside than inside, because I assume my house will still cool off in the evening.)</li>
  <li>An <code class="language-plaintext highlighter-rouge">input_number</code> with entity ID <code class="language-plaintext highlighter-rouge">input_number.temperature_inversion_required_duration</code>, which represents how long in minutes it should be cooler outside before I get a notification. (I.e. if the temperature is bouncing up and down, I don’t need a notification yet.)</li>
  <li>An <code class="language-plaintext highlighter-rouge">input_select</code> with entity ID <code class="language-plaintext highlighter-rouge">input_select.tid_desired_window_state</code>, which will store the desired window state for other use in Home Assistant.</li>
  <li>An <code class="language-plaintext highlighter-rouge">input_text</code> with entity ID <code class="language-plaintext highlighter-rouge">input_text.tid_status</code>, which will store a short summary of the desired action (and be an empty string otherwise).</li>
</ul>

<p>Next, I ensure that the indoor temperature sensor I’m using is assigned to an Area, so the automation can tell me which room’s windows I need to open or close later.</p>

<p>Next, to get today’s high, I setup the <a href="https://www.home-assistant.io/integrations/accuweather">AccuWeather integration</a>. It creates a ton of sensors, but the only one I care about is today’s high: <code class="language-plaintext highlighter-rouge">sensor.home_realfeel_temperature_max_0d</code>. I disabled all the others.</p>

<p>Next, in my <code class="language-plaintext highlighter-rouge">configuration.yaml</code> I create a group to represent all the window sensors in one room, like so:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">binary_sensor</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">group</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Windows Upstairs Front</span>
    <span class="na">device_class</span><span class="pi">:</span> <span class="s">window</span>
    <span class="na">unique_id</span><span class="pi">:</span> <span class="s">windows_upstairs_front</span>
    <span class="na">entities</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">binary_sensor.window_sensor_upstairs_den_1_any</span>
      <span class="pi">-</span> <span class="s">binary_sensor.window_sensor_upstairs_den_2_any</span>
      <span class="pi">-</span> <span class="s">binary_sensor.window_sensor_upstairs_den_4_any</span>
</code></pre></div></div>
<p>This allows me to treat them all as one sensor. Note that this group will be “off” (“closed”) only if all the windows in the group are closed. That’s OK–I only really care if at least one of the windows is open or not.</p>

<p>Next, also in <code class="language-plaintext highlighter-rouge">configuration.yaml</code>, I create a couple of <a href="https://www.home-assistant.io/integrations/template/">template sensors</a>:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="na">template</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">binary_sensor</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">unique_id</span><span class="pi">:</span> <span class="s">temperature_cooler_outside</span>
        <span class="na">state</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">{{ states("sensor.indoor_temperature_sensor")|float &gt;= states("input_number.temperature_inversion_difference")|float + states("sensor.outdoor_temperature_sensor")|float }}</span>
        <span class="na">delay_on</span><span class="pi">:</span> <span class="s1">'</span><span class="s">00:{{</span><span class="nv"> </span><span class="s">states("input_number.temperature_inversion_required_duration")|int(1)</span><span class="nv"> </span><span class="s">}}:00'</span>

      <span class="pi">-</span> <span class="na">unique_id</span><span class="pi">:</span> <span class="s">temperature_above_threshold</span>
        <span class="na">state</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">{{ states("sensor.indoor_temperature_sensor") &gt; states("input_number.temperature_inversion_indoor_threshold") }}</span>
        <span class="na">delay_on</span><span class="pi">:</span> <span class="s1">'</span><span class="s">00:{{</span><span class="nv"> </span><span class="s">states("input_number.temperature_inversion_required_duration")|int(1)</span><span class="nv"> </span><span class="s">}}:00'</span>

      <span class="pi">-</span> <span class="na">unique_id</span><span class="pi">:</span> <span class="s">tid_high_greater_than_threshold</span>
        <span class="na">state</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">{{ states("sensor.home_realfeel_temperature_max_0d") &gt;= states("input_number.temperature_inversion_outdoor_max_high") }}</span>

</code></pre></div></div>
<p>The first indicates whether or not the indoor temperature is greater than the outdoor temperature by some margin (thus it’s cooler outside).</p>

<p>The second indicates if the indoor temperature is above the threshold I configure (i.e. it’s warm enough inside that I want to know when I can cool things down).</p>

<p>The third just indicates if today’s high is greater than the threshold I configure.</p>

<h1 id="the-automation-blueprint">The automation blueprint</h1>

<p>With all that set up, I can now just plug it all into the following automation blueprint:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="na">blueprint</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">Temperature Inversion Automation</span>
  <span class="na">description</span><span class="pi">:</span> <span class="s">Run specific actions when it's cooler outside than inside, and vice versa.</span>
  <span class="na">domain</span><span class="pi">:</span> <span class="s">automation</span>
  <span class="na">input</span><span class="pi">:</span>
    <span class="na">indoor_temperature_sensor</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">Indoor Temperature Sensor</span>
      <span class="na">selector</span><span class="pi">:</span>
        <span class="na">entity</span><span class="pi">:</span>
          <span class="na">domain</span><span class="pi">:</span> <span class="s">sensor</span>
          <span class="na">device_class</span><span class="pi">:</span> <span class="s">temperature</span>
    <span class="na">outdoor_temperature_sensor</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">Outdoor Temperature Sensor</span>
      <span class="na">selector</span><span class="pi">:</span>
        <span class="na">entity</span><span class="pi">:</span>
          <span class="na">domain</span><span class="pi">:</span> <span class="s">sensor</span>
          <span class="na">device_class</span><span class="pi">:</span> <span class="s">temperature</span>
    <span class="na">window_binary_sensor</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">Window binary sensor</span>
      <span class="na">selector</span><span class="pi">:</span>
        <span class="na">entity</span><span class="pi">:</span>
          <span class="na">domain</span><span class="pi">:</span> <span class="s">binary_sensor</span>
          <span class="na">device_class</span><span class="pi">:</span> <span class="s">window</span>
    <span class="na">cooler_outside_binary_sensor</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">Cooler Outside Binary Sensor</span>
      <span class="na">selector</span><span class="pi">:</span>
        <span class="na">entity</span><span class="pi">:</span>
          <span class="na">domain</span><span class="pi">:</span> <span class="s">binary_sensor</span>
    <span class="na">indoors_above_threshold_binary_sensor</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">Indoors Above Threshold Binary Sensor</span>
      <span class="na">selector</span><span class="pi">:</span>
        <span class="na">entity</span><span class="pi">:</span>
          <span class="na">domain</span><span class="pi">:</span> <span class="s">binary_sensor</span>
    <span class="na">outdoor_high_greater_than_threshold_binary_sensor</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">Outdoor High Greater Than Threshold Binary Sensor</span>
      <span class="na">selector</span><span class="pi">:</span>
        <span class="na">entity</span><span class="pi">:</span>
          <span class="na">domain</span><span class="pi">:</span> <span class="s">binary_sensor</span>
    <span class="na">desired_window_state_input_select</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">Desired Window State Input Select</span>
      <span class="na">selector</span><span class="pi">:</span>
        <span class="na">entity</span><span class="pi">:</span>
          <span class="na">domain</span><span class="pi">:</span> <span class="s">input_select</span>
    <span class="na">status_title_text</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">Status Title Text</span>
      <span class="na">selector</span><span class="pi">:</span>
        <span class="na">entity</span><span class="pi">:</span>
          <span class="na">domain</span><span class="pi">:</span> <span class="s">input_text</span>
    <span class="na">notification_event</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">Notification Event</span>
      <span class="na">selector</span><span class="pi">:</span>
        <span class="na">text</span><span class="pi">:</span>
<span class="na">trigger</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">state</span>
    <span class="na">entity_id</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">cooler_outside_binary_sensor</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">state</span>
    <span class="na">entity_id</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">indoors_above_threshold_binary_sensor</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">state</span>
    <span class="na">entity_id</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">window_binary_sensor</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">state</span>
    <span class="na">entity_id</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">indoor_temperature_sensor</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">state</span>
    <span class="na">entity_id</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">outdoor_temperature_sensor</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">state</span>
    <span class="na">entity_id</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">outdoor_high_greater_than_threshold_binary_sensor</span>
<span class="na">action</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">variables</span><span class="pi">:</span>
      <span class="na">indoor_temperature_sensor</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">indoor_temperature_sensor</span>
      <span class="na">outdoor_temperature_sensor</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">outdoor_temperature_sensor</span>
      <span class="na">window_binary_sensor</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">window_binary_sensor</span>
  <span class="pi">-</span> <span class="na">service</span><span class="pi">:</span> <span class="s">input_select.set_options</span>
    <span class="na">target</span><span class="pi">:</span>
      <span class="na">entity_id</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">desired_window_state_input_select</span>
    <span class="na">data</span><span class="pi">:</span>
      <span class="na">options</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">on"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">off"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">any"</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="na">choose</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">conditions</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">condition</span><span class="pi">:</span> <span class="s">state</span>
            <span class="na">entity_id</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">cooler_outside_binary_sensor</span>
            <span class="na">state</span><span class="pi">:</span> <span class="s2">"</span><span class="s">on"</span>
          <span class="pi">-</span> <span class="na">condition</span><span class="pi">:</span> <span class="s">state</span>
            <span class="na">entity_id</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">indoors_above_threshold_binary_sensor</span>
            <span class="na">state</span><span class="pi">:</span> <span class="s2">"</span><span class="s">on"</span>
        <span class="na">sequence</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">service</span><span class="pi">:</span> <span class="s">input_select.select_option</span>
            <span class="na">data</span><span class="pi">:</span>
              <span class="na">option</span><span class="pi">:</span> <span class="s2">"</span><span class="s">on"</span>
            <span class="na">target</span><span class="pi">:</span>
              <span class="na">entity_id</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">desired_window_state_input_select</span>
          <span class="pi">-</span> <span class="na">event</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">notification_event</span>
            <span class="na">event_data</span><span class="pi">:</span>
              <span class="na">title</span><span class="pi">:</span> <span class="pi">&gt;-</span>
                <span class="s">{% if states(window_binary_sensor) == "off" %}</span>
                <span class="s">Open the {{ area_name(indoor_temperature_sensor) }} windows</span>
                <span class="s">{% endif %}</span>
              <span class="na">message</span><span class="pi">:</span> <span class="pi">&gt;-</span>
                <span class="s">{% if states(window_binary_sensor) == "off" %}</span>
                <span class="s">It is currently {{  states(indoor_temperature_sensor) }}{{ state_attr(indoor_temperature_sensor, "unit_of_measurement") }} in the {{ area_name(indoor_temperature_sensor) }} and {{ states(outdoor_temperature_sensor) }}{{ state_attr(outdoor_temperature_sensor, "unit_of_measurement") }} outside.</span>
                <span class="s">{% else %}</span>
                <span class="s">clear_notification</span>
                <span class="s">{% endif %}</span>
          <span class="pi">-</span> <span class="na">service</span><span class="pi">:</span> <span class="s">input_text.set_value</span>
            <span class="na">data</span><span class="pi">:</span>
              <span class="na">value</span><span class="pi">:</span> <span class="pi">&gt;-</span>
                <span class="s">{% if states(window_binary_sensor) == "off" %}</span>
                <span class="s">Open the {{ area_name(indoor_temperature_sensor) }} windows</span>
                <span class="s">{% endif %}</span>
            <span class="na">target</span><span class="pi">:</span>
              <span class="na">entity_id</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">status_title_text</span>
      <span class="pi">-</span> <span class="na">conditions</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">condition</span><span class="pi">:</span> <span class="s">state</span>
            <span class="na">entity_id</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">outdoor_high_greater_than_threshold_binary_sensor</span>
            <span class="na">state</span><span class="pi">:</span> <span class="s2">"</span><span class="s">on"</span>
          <span class="pi">-</span> <span class="na">condition</span><span class="pi">:</span> <span class="s">state</span>
            <span class="na">entity_id</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">cooler_outside_binary_sensor</span>
            <span class="na">state</span><span class="pi">:</span> <span class="s2">"</span><span class="s">off"</span>
        <span class="na">sequence</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">service</span><span class="pi">:</span> <span class="s">input_select.select_option</span>
            <span class="na">data</span><span class="pi">:</span>
              <span class="na">option</span><span class="pi">:</span> <span class="s2">"</span><span class="s">off"</span>
            <span class="na">target</span><span class="pi">:</span>
              <span class="na">entity_id</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">desired_window_state_input_select</span>
          <span class="pi">-</span> <span class="na">event</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">notification_event</span>
            <span class="na">event_data</span><span class="pi">:</span>
              <span class="na">title</span><span class="pi">:</span> <span class="pi">&gt;-</span>
                <span class="s">{% if states(window_binary_sensor) == "on" %}</span>
                <span class="s">Close the {{ area_name(indoor_temperature_sensor) }} windows</span>
                <span class="s">{% endif %}</span>
              <span class="na">message</span><span class="pi">:</span> <span class="pi">&gt;-</span>
                <span class="s">{% if states(window_binary_sensor) == "on" %}</span>
                <span class="s">The high today is {{ states("sensor.home_realfeel_temperature_max_0d") }}{{ state_attr("sensor.home_realfeel_temperature_max_0d", "unit_of_measurement") }}, and it is currently {{ states(indoor_temperature_sensor) }}{{ state_attr(indoor_temperature_sensor, "unit_of_measurement") }} in the {{ area_name(indoor_temperature_sensor) }} and {{ states(outdoor_temperature_sensor) }}{{ state_attr(outdoor_temperature_sensor, "unit_of_measurement") }} outside.</span>
                <span class="s">{% else %}</span>
                <span class="s">clear_notification</span>
                <span class="s">{% endif %}</span>
          <span class="pi">-</span> <span class="na">service</span><span class="pi">:</span> <span class="s">input_text.set_value</span>
            <span class="na">data</span><span class="pi">:</span>
              <span class="na">value</span><span class="pi">:</span> <span class="pi">&gt;-</span>
                <span class="s">{% if states(window_binary_sensor) == "on" %}</span>
                <span class="s">Close the {{ area_name(indoor_temperature_sensor) }} windows</span>
                <span class="s">{% endif %}</span>
            <span class="na">target</span><span class="pi">:</span>
              <span class="na">entity_id</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">status_title_text</span>
    <span class="na">default</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">service</span><span class="pi">:</span> <span class="s">input_select.select_option</span>
        <span class="na">data</span><span class="pi">:</span>
          <span class="na">option</span><span class="pi">:</span> <span class="s">any</span>
        <span class="na">target</span><span class="pi">:</span>
          <span class="na">entity_id</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">desired_window_state_input_select</span>
      <span class="pi">-</span> <span class="na">event</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">notification_event</span>
        <span class="na">event_data</span><span class="pi">:</span>
          <span class="na">message</span><span class="pi">:</span> <span class="s">clear_notification</span>
      <span class="pi">-</span> <span class="na">service</span><span class="pi">:</span> <span class="s">input_text.set_value</span>
        <span class="na">data</span><span class="pi">:</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
        <span class="na">target</span><span class="pi">:</span>
          <span class="na">entity_id</span><span class="pi">:</span> <span class="kt">!input</span> <span class="s">status_title_text</span>
<span class="na">mode</span><span class="pi">:</span> <span class="s">restart</span>

</code></pre></div></div>
<p>Let’s see how it works.</p>

<h1 id="breaking-down-the-automation">Breaking down the automation</h1>

<h2 id="the-inputs">The inputs</h2>

<p>The inputs are pretty self-explanatory–just match each up to the actual sensor or template sensor from the earlier sections.</p>

<p>The only one we haven’t covered is the “Notification Event”. This is the name of a custom event that will fire to trigger the notification. I use a custom event since I want to use my <a href="/2022/07/updating-uncleared-home-assistant-android-notifications-with-appdaemon/">custom AppDaemon app that only updates uncleared notifications</a>. For reference, here’s the YAML I use to configure that app:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">update_tid_notifications_upstairs_front</span><span class="pi">:</span>
  <span class="na">module</span><span class="pi">:</span> <span class="s">update_uncleared_android_notifications</span>
  <span class="na">class</span><span class="pi">:</span> <span class="s">UpdateUnclearedAndroidNotifications</span>
  <span class="na">notification_targets</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">&lt;redacted device ID 1&gt;</span>
    <span class="pi">-</span> <span class="s">&lt;redacted device ID 2&gt;</span>
  <span class="na">notification_data</span><span class="pi">:</span>
    <span class="na">alert_once</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">sticky</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">clickAction</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/lovelace-default/cooling"</span>
</code></pre></div></div>
<p>As you can see, it will send notifications to two Android devices, and clicking on the notification will open up the Home Assistant app and take you to the cooling dashboard.</p>

<h2 id="the-triggers">The triggers</h2>

<p>The triggers are also self-explanatory–if any of the sensors changes, we should run the automation.</p>

<h2 id="the-actions">The actions</h2>

<p>Here’s where it gets good. First, we create some variables based on the inputs so we can use them in templates later on.</p>

<p>Second, we initialize that <code class="language-plaintext highlighter-rouge">input_select</code> that will contain the desired window state.</p>

<p>We then use one giant <a href="https://www.home-assistant.io/docs/scripts#choose-a-group-of-actions">choose statement</a> to test the two conditions we described at the top of the guide, or run a default sequence if neither of those conditions is true.</p>

<p>For the first condition, the <code class="language-plaintext highlighter-rouge">cooler_outside_binary_sensor</code> and the <code class="language-plaintext highlighter-rouge">indoors_above_threshold_binary_sensor</code> must both be on. If so, then we set the desired window state to “on” (meaning “open”). We then fire off our notification event with a message about what the current temperature is, but note that we use templates so that the fields only have the message if the desired window state (“on”) doesn’t match the current window state (“off”). If it does match, then we clear the notification because we don’t need to take any action.</p>

<p>Note that the template for the message does some fancy stuff: it figures out what room’s windows to open by using the <a href="https://www.home-assistant.io/docs/configuration/templating/#areas"><code class="language-plaintext highlighter-rouge">area_name</code></a> function, and it gets the units of the sensor by using the <a href="https://www.home-assistant.io/docs/configuration/templating/#states"><code class="language-plaintext highlighter-rouge">state_attr</code></a> function to get the <code class="language-plaintext highlighter-rouge">unit_of_measurement</code> attribute.</p>

<p>After sending the message, we also set the <code class="language-plaintext highlighter-rouge">status_title_text</code> to a short description of what we need to do, for use in the Lovelace dashboard.</p>

<p>The second condition proceeds similarly. Finally, the default action (if neither set of conditions is true) just sets the desired window state to <code class="language-plaintext highlighter-rouge">any</code>, and clears the notification and our status text.</p>

<h1 id="its-reusable">It’s reusable!</h1>

<p>Since it’s a template, it’s easy to re-use this for multiple rooms. (This is useful for me because the back of my house is often cooler than the front of my house.) All I have to do is create new template sensors, and then re-fill in the blueprint.</p>

<h1 id="bonus-a-dynamic-lovelace-card">Bonus: a dynamic Lovelace card</h1>

<p><img src="/assets/images/tid_lovelace_card.png" alt="Dynamic Lovelace Card" /></p>

<p>To make a nice card in Lovelace that shows me what the current status is in the front and back of my house (and outside on either side), I installed the <a href="https://github.com/ofekashery/vertical-stack-in-card">Vertical Stack in Card</a> and <a href="https://github.com/thomasloven/lovelace-card-mod">card-mod</a> HACS Frontend components.</p>

<p>I only want the card to appear when any of the windows needs to be either open or closed. However, the Lovelace <a href="https://www.home-assistant.io/dashboards/conditional/">conditional card</a> doesn’t support templates, so I first had to drop the following template sensor into <code class="language-plaintext highlighter-rouge">configuration.yaml</code>:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="na">template</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">binary_sensor</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">unique_id</span><span class="pi">:</span> <span class="s">tid_any_upstairs_window_should_change</span>
        <span class="na">state</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">{{ "on" if ((states("input_select.tid_upstairs_front_desired_window_state") != "any") or</span>
                      <span class="s">(states("input_select.tid_desired_window_state_upstairs_back") != "any"))</span>
          <span class="s">else "off" }}</span>

</code></pre></div></div>
<p>As you can see, it’s “on” if any of the windows are in a state other than “any.”</p>

<p>I also added a group containing all the status messages, so I could iterate over them in the card:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">group</span><span class="pi">:</span>
  <span class="na">tid_status_titles</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">TID</span><span class="nv"> </span><span class="s">Status</span><span class="nv"> </span><span class="s">Titles"</span>
    <span class="na">entities</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">input_text.tid_upstairs_back_status_title</span>
      <span class="pi">-</span> <span class="s">input_text.tid_upstairs_front_status_title</span>
</code></pre></div></div>

<p>With that setup, here’s the YAML for the resulting card:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="na">type</span><span class="pi">:</span> <span class="s">conditional</span>
<span class="na">conditions</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">entity</span><span class="pi">:</span> <span class="s">binary_sensor.template_tid_any_upstairs_window_should_change</span>
    <span class="na">state</span><span class="pi">:</span> <span class="s1">'</span><span class="s">on'</span>
<span class="na">card</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">custom:vertical-stack-in-card</span>
  <span class="na">title</span><span class="pi">:</span> <span class="s">Upstairs Cooling Status</span>
  <span class="na">card_mod</span><span class="pi">:</span>
    <span class="na">style</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">.card-header {</span>
        <span class="s">padding-bottom: 0px;</span>
      <span class="s">}</span>
  <span class="na">cards</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">markdown</span>
      <span class="na">content</span><span class="pi">:</span> <span class="pi">&gt;-</span>
        <span class="s">{% for status_title in expand("group.tid_status_titles") %}</span>
          <span class="s">{% if states(status_title.entity_id) != "" %}</span>
        <span class="s">### &lt;ha-icon icon="mdi:alert"&gt;&lt;/ha-icon&gt;</span>
        <span class="s">*{{states(status_title.entity_id)}}*</span>
          <span class="s">{% endif %}</span>
        <span class="s">{% endfor %}</span>
      <span class="na">card_mod</span><span class="pi">:</span>
        <span class="na">style</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">ha-markdown.no-header {</span>
            <span class="s">padding-top: 0px !important;</span>
            <span class="s">padding-bottom: 0px !important;</span>
          <span class="s">}</span>
    <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">glance</span>
      <span class="na">entities</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">entity</span><span class="pi">:</span> <span class="s">sensor.outdoor_front_temperature_sensor_mysensors_0</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">Front</span>
        <span class="pi">-</span> <span class="na">entity</span><span class="pi">:</span> <span class="s">binary_sensor.windows_upstairs_front</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">Den</span>
          <span class="na">card_mod</span><span class="pi">:</span>
            <span class="na">style</span><span class="pi">:</span> <span class="pi">|</span>
              <span class="s">:host {</span>
                <span class="s">--paper-item-icon-color: {{ "initial" if is_state("input_select.tid_upstairs_front_desired_window_state", "any") else ("green" if is_state("binary_sensor.windows_upstairs_front", states("input_select.tid_upstairs_front_desired_window_state")) else "red") }}</span>
              <span class="s">}</span>
        <span class="pi">-</span> <span class="na">entity</span><span class="pi">:</span> <span class="s">sensor.aerq_temperature_and_humidity_sensor_v2_0_air_temperature_2</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">Den</span>
        <span class="pi">-</span> <span class="na">entity</span><span class="pi">:</span> <span class="s">sensor.aerq_temperature_and_humidity_sensor_v2_0_air_temperature</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">Master Bedroom</span>
        <span class="pi">-</span> <span class="na">entity</span><span class="pi">:</span> <span class="s">binary_sensor.windows_upstairs_back</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">Master Bedroom</span>
          <span class="na">card_mod</span><span class="pi">:</span>
            <span class="na">style</span><span class="pi">:</span> <span class="pi">|</span>
              <span class="s">:host {</span>
                <span class="s">--paper-item-icon-color: {{ "initial" if is_state("input_select.tid_desired_window_state_upstairs_back", "any") else ("green" if is_state("binary_sensor.windows_upstairs_back", states("input_select.tid_desired_window_state_upstairs_back")) else "red") }}</span>
              <span class="s">}</span>
        <span class="pi">-</span> <span class="na">entity</span><span class="pi">:</span> <span class="s">sensor.temp_sensor_outdoor_back_mysensors_0</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">Back</span>
      <span class="na">state_color</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">show_name</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">show_state</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">show_icon</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">columns</span><span class="pi">:</span> <span class="m">6</span>

</code></pre></div></div>

<p>There’s a lot going on here, so lets break it down.</p>

<p>The first parts are about creating the condition card, which shows a <code class="language-plaintext highlighter-rouge">custom:vertical-stack-in-card</code> if the condition is true.</p>

<p>The vertical stack has two cards: the first is a markdown card which iterates over the status in the group, and if it’s not empty, prints it in bold next to a nice little <a href="https://www.home-assistant.io/dashboards/markdown/#icons">alert icon</a>.</p>

<p>The second card is a <a href="https://www.home-assistant.io/dashboards/glance/">glance card</a> which is fairly straightforward. The only neat part here is that I use card-mod to color the icon of the windows red if they aren’t in their desired state, green if they are in their desired state, and I leave them alone if their desired state is “any.” (Apparently the CSS property <code class="language-plaintext highlighter-rouge">--paper-item-icon-color</code> controls the color.)</p>

<p>There’s some other minor CSS modification using card-mod throughout, but that’s mostly cosmetic.</p>

<h1 id="conclusion">Conclusion</h1>

<p>And that’s it! I now get notifications when I need to open or close my windows, and my house’s temperature is far more comfortable.</p>
 
                     
 
                   </div> 
                </div>
              </div>
            </div>
            <div class="col-md-3 hidden-xs">
              
<div class="sidebar ">
  <h2>In This Post:</h2>
  <ul class="toc">
  <li><a href="#goals">Goals</a></li>
  <li><a href="#setup">Setup</a></li>
  <li><a href="#the-automation-blueprint">The automation blueprint</a></li>
  <li><a href="#breaking-down-the-automation">Breaking down the automation</a>
    <ul>
      <li><a href="#the-inputs">The inputs</a></li>
      <li><a href="#the-triggers">The triggers</a></li>
      <li><a href="#the-actions">The actions</a></li>
    </ul>
  </li>
  <li><a href="#its-reusable">It’s reusable!</a></li>
  <li><a href="#bonus-a-dynamic-lovelace-card">Bonus: a dynamic Lovelace card</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>
</div>


<div class="sidebar ">
  <h2>Recent Posts</h2>
  <ul>
    
    <li><a href="/2022/11/backups/">Server Backups!</a></li>
    
    <li><a href="/2022/10/hosting-your-own-apt-repo-cache/">Hosting Your Own Apt Repo Cache</a></li>
    
    <li><a href="/2022/07/getting-home-assistant-to-tell-me-when-to-open-the-windows/">Getting Home Assistant to Tell Me When to Open the Windows</a></li>
    
    <li><a href="/2022/07/updating-uncleared-home-assistant-android-notifications-with-appdaemon/">Updating Uncleared Home Assistant Android Notifications with AppDaemon</a></li>
    
    <li><a href="/2022/07/automatically-update-parameters-of-a-sleeping-z-wave-entity-in-home-assistant/">Update Parameters of a Sleeping Z-Wave Device in Home Assistant on a Schedule</a></li>
    
  </ul>
</div>

<div class="sidebar">
  <h2>Tags</h2>
  <ul class="fa-ul">
    
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/apache2" data-toggle="tooltip" data-placement="right" title="1">
        <span>apache2</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/appdaemon" data-toggle="tooltip" data-placement="right" title="1">
        <span>appdaemon</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/apt" data-toggle="tooltip" data-placement="right" title="1">
        <span>apt</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/apt-cacher-ng" data-toggle="tooltip" data-placement="right" title="1">
        <span>apt-cacher-ng</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/apt-clone" data-toggle="tooltip" data-placement="right" title="1">
        <span>apt-clone</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/automations" data-toggle="tooltip" data-placement="right" title="2">
        <span>automations</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/backups" data-toggle="tooltip" data-placement="right" title="2">
        <span>backups</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/blueprint" data-toggle="tooltip" data-placement="right" title="1">
        <span>blueprint</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/borg" data-toggle="tooltip" data-placement="right" title="1">
        <span>borg</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/borgmatic" data-toggle="tooltip" data-placement="right" title="1">
        <span>borgmatic</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/github" data-toggle="tooltip" data-placement="right" title="1">
        <span>github</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/homeassistant" data-toggle="tooltip" data-placement="right" title="3">
        <span>homeassistant</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/https" data-toggle="tooltip" data-placement="right" title="1">
        <span>https</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/jekyll" data-toggle="tooltip" data-placement="right" title="1">
        <span>jekyll</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/ruby" data-toggle="tooltip" data-placement="right" title="1">
        <span>ruby</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/scripts" data-toggle="tooltip" data-placement="right" title="1">
        <span>scripts</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/syncthing" data-toggle="tooltip" data-placement="right" title="1">
        <span>syncthing</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/timeshift" data-toggle="tooltip" data-placement="right" title="1">
        <span>timeshift</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/zwave" data-toggle="tooltip" data-placement="right" title="1">
        <span>zwave</span></a></li>
    
  </ul>
</div>

            </div>
          </div>
        </div>
      </div>
          <footer class="footer-distributed">
      <div class="container">
        <div class="footer">
          <p>Jeremy Gillula &copy; 2022
          <br>Theme: <a href="https://github.com/streetturtle/jekyll-clean-dark">Jekyll Clean Dark</a> with modifications</p>
        </div>
      </div>
    </footer>

    </div>
  </body>
</html>
