








<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Random Hacks | Hosting Your Own Apt Repo Cache </title>
    <meta name="theme-color" content="#222222"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/popper.min.js"></script>
    <script src="/assets/js/bootstrap4.min.js"></script>
    <script src="/assets/js/header.js"></script>
    <script src="/assets/css/svg-with-js/js/fontawesome-all.js"></script>
    <link href="/assets/css/bootstrap4.min.css" rel="stylesheet">
    <link href="/assets/css/theme.css" rel="stylesheet">
    <link href="/assets/css/syntax.css" rel="stylesheet">
 </head>

<body>

<script type="text/javascript">
    WebFontConfig = {
        google: {
            families: ['Ubuntu::latin']
        }
    };
    (function () {
        var wf = document.createElement('script');
        wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
            '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
        wf.type = 'text/javascript';
        wf.async = 'true';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(wf, s);
    })();


 function InitCopyPaste(){
   const codeBlocks = document.querySelectorAll("div.highlighter-rouge");

   codeBlocks.forEach((codeblock, index) => {
     const code = codeBlocks[index].innerText;
     const copyCodeButton = document.createElement("button");
     copyCodeButton.innerHTML = "COPY";
     copyCodeButton.classList = "btn btn-sm btn-outline-primary";
     // insert a copy button
     copyCodeButton.onclick = function () {
       window.navigator.clipboard.writeText(code);
       copyCodeButton.innerHTML = "COPIED";
       copyCodeButton.classList.add("btn-success");
       copyCodeButton.classList.remove("btn-outline-primary");

       setTimeout(() => {
         copyCodeButton.innerHTML = "COPY";
         copyCodeButton.classList.remove("btn-success");
         copyCodeButton.classList.add("btn-outline-primary");
       }, 2000);
     };
     // make the button
     codeblock.appendChild(copyCodeButton);
   });
 }

 document.addEventListener("DOMContentLoaded", InitCopyPaste);
</script>


<script>
 $(document).ready(function(){

 const headings = document.querySelectorAll('h1[id], h2[id],h3[id]'); // 1
   const linkContent = '<i class="fas fa-link"></i>'; // 2
   for (const heading of headings) { // 3
                                     const space = document.createElement('span');
     space.innerHTML=" ";
     space.className = "header_link_span";
   const linkIcon = document.createElement('a'); // 4
   linkIcon.setAttribute('href', `#${heading.id}`); // 5
   linkIcon.className = "header_link";
   linkIcon.innerHTML = linkContent; // 6
   space.appendChild(linkIcon); // 7
     heading.appendChild(space);
 }
   });
</script>



<nav class="navbar navbar-expand-lg fixed-top navbar-dark">
    <div class="container">
        <a class="navbar-brand offset-md-1" href="/">Random Hacks</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse"
                data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup"
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
          <div class="navbar-nav">
            <a class="nav-item nav-link" href="/">Home</a>
            <a class="nav-item nav-link" href="/about">About</a>
          </div>
        </div>
    </div>
</nav>

    <div class="wrapper">
      <div class="content">
        <div class="container container-center">
          <div class="row">
            <div class="col-md-8 offset-md-1">
              <div class="article">
                <div class="card">
                  <h1><a href="/2022/10/hosting-your-own-apt-repo-cache/">Hosting Your Own Apt Repo Cache</a></h1>
                  <div class="post-meta">
                    <div class="post-time">
                      <i class="fa fa-calendar-alt"></i>
                      <time>29 Oct 2022</time>
                    </div>
                    <ul>
                      
                        <li><a href="/tag/backups">backups</a></li>
                      
                        <li><a href="/tag/apt">apt</a></li>
                      
                        <li><a href="/tag/syncthing">syncthing</a></li>
                      
                    </ul>
                  </div>
                   <div class="post-content"> 
                     <h1 id="motivation">Motivation</h1>

<p>I’m picky about the software running on my machine, but I also want to be able to try new updates. That means sometimes I want to be able to roll back installation or upgrades of <code class="language-plaintext highlighter-rouge">apt</code> packages. There are good tools that help you do this like <a href="https://github.com/mvo5/apt-clone"><code class="language-plaintext highlighter-rouge">apt-clone</code></a> and <a href="https://gitlab.com/fabio.dellaria/apt-rollback#apt-rollback"><code class="language-plaintext highlighter-rouge">apt-rollback</code></a>, but they’re only useful if you actually have the older versions of the packages you want to downgrade to. While older versions of most packages can probably be found somewhere on the Internet (and <code class="language-plaintext highlighter-rouge">apt-rollback</code> even tries to find some of them), finding them can be a chore. Additionally, many third-party repos don’t host older versions once newer ones are posted. Thus since storage space is cheap I’d rather just host them myself.</p>

<p>Note that one solution here is to use <a href="https://www.unix-ag.uni-kl.de/~bloch/acng/"><code class="language-plaintext highlighter-rouge">apt-cacher-ng</code></a>. I tried <a href="/2022/04/setting-up-apt-cacher-ng-with-https/">using it at first</a>, but it was really complicated to make it intercept HTTPS traffic and it often failed when I would try to do an <code class="language-plaintext highlighter-rouge">apt update</code>. Instead, I’ve decided to hack together my own version of it using the absolutely fantastic <a href="https://syncthing.net/">Syncthing</a> and a little bash scripting glue.</p>

<h2 id="the-plan">The plan</h2>

<p>The idea is actually pretty simple:</p>
<ul>
  <li>Every time one of my machines upgrades or installs a new package, it will of course cache the <code class="language-plaintext highlighter-rouge">.deb</code> file temporarily in <code class="language-plaintext highlighter-rouge">/var/cache/apt/archives/</code>.</li>
  <li>I’ll then use Syncthing to sync that cache to my home server.</li>
  <li>I’ll then use a little bash scripting + apache to turn that cache into an honest-to-god apt package repo.</li>
  <li>I then just add that repo to all of my machines, and any time they need an old package, they can get it from the repo.</li>
</ul>

<p>Obviously there’s some subtlety here, so let’s dive in.</p>

<h1 id="syncing-with-syncthing">Syncing with Syncthing</h1>

<h2 id="on-the-client">On the client</h2>

<p>The first thing I did was add <code class="language-plaintext highlighter-rouge">/var/cache/apt/archives/</code> as a folder to sync in Syncthing on one of my client machines. Since that folder is owned by root I had to temporarily <code class="language-plaintext highlighter-rouge">chmod</code> it so that the user I run Syncthing as could write to it, just to create the <code class="language-plaintext highlighter-rouge">.stfolder</code> folder and <code class="language-plaintext highlighter-rouge">.stignore</code> file. I named the folder to match the release of the client (e.g. bionic, jammy, etc.), since at the moment the client and the server are on different releases. I also made the folder “Send Only”, and made sure to turn off versioning. With all that done, I could share it to the server.</p>

<h2 id="on-the-server">On the server</h2>

<p>On the server I created the directory from which I wanted to host my apt repo, e.g. <code class="language-plaintext highlighter-rouge">/srv/backups/apt-packages/</code>. Then since <a href="https://wiki.debian.org/DebianRepository/Format#Debian_Repository_Format:~:text=The%20distribution%20part%20(stable%20in%20this%20case)%20specifies%20a%20subdirectory%20in%20%24ARCHIVE_ROOT/dists.">apt expects specific releases/distributions to be in a <code class="language-plaintext highlighter-rouge">dists</code> subdirectory</a>, I made that too. Finally, I created a directory for that particular distribution, ending up with a directory like <code class="language-plaintext highlighter-rouge">/srv/backups/apt-packages/dists/bionic</code>. I made sure the Syncthing user on the server had write permissions, and then accepted the shared folder, pointing Syncthing at this new directory.</p>

<p>I also made this folder “Receive Only”, turned off versioning, and added the following as ignore patterns (since these will be files that will be created to host the repo, and really don’t need to be synced):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Release
main
InRelease
</code></pre></div></div>
<p>Last but not least I <a href="https://docs.syncthing.net/v1.22.0/users/config#config-option-folder.ignoredelete">turned off deletes</a> via the Actions &gt; Advanced &gt; Folders &gt; bionic packages menu. This way, even when my clients delete their local copy of a package, the version on the server will stay.</p>

<h1 id="turning-a-synced-folder-into-an-apt-repository">Turning a synced folder into an apt repository</h1>

<p>The next step is to turn this synced folder into an apt repository. There are <a href="https://askubuntu.com/questions/170348/how-to-create-a-local-apt-repository">several</a> <a href="https://help.ubuntu.com/community/CreateAuthenticatedRepository">guides</a> and <a href="https://wiki.debian.org/DebianRepository/Format">resources</a> on how to do this. After perusing them all, I put together a <a href="https://github.com/jgillula/apt-repo-manager/tree/v1.0.0#readme">little script that does it all for me, automatically</a>. Basically just follow the instructions there.</p>

<p>Don’t forget to use the cron file to refresh the repo on a daily/hourly/whatever basis.</p>

<h1 id="hosting-it">Hosting it</h1>

<p>Now we need to make the repo accessible from the network. I want it to be accessible over HTTPS, so the first step is to get an HTTPS certificate. I already wrote about how to do this <a href="/2022/04/setting-up-apt-cacher-ng-with-https/#1-getting-the-https-certificate">in my guide to setting up apt-cacher-ng</a>, so just follow step #1 there.</p>

<p>Next, we need to add the apache config that will host the repo, i.e. <code class="language-plaintext highlighter-rouge">/etc/apache2/sites-available/apt-repo.conf</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;VirtualHost *:443&gt;
    ServerName apt-repo.servername
    DocumentRoot /srv/backups/apt-packages

    &lt;Directory /&gt;
      Require all granted
      Options Indexes
  &lt;/Directory&gt;

  SSLEngine on
  SSLCertificateFile    /etc/ssl/certs/apt-repo.pem
  SSLCertificateKeyFile /etc/ssl/private/apt-repo.key
&lt;/VirtualHost&gt;
</code></pre></div></div>
<p>Make sure to adjust <code class="language-plaintext highlighter-rouge">apt-repo.servername</code> to whatever the hostname of your server actually is, and also the <code class="language-plaintext highlighter-rouge">DocumentRoot</code> to wherever you’re actually keeping the repo (i.e. the parent of the <code class="language-plaintext highlighter-rouge">dists</code> directory).</p>

<p>Then just do</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>a2ensite apt-repo.conf
<span class="nb">sudo </span>a2enmod ssl
<span class="nb">sudo </span>systemctl restart apache2
</code></pre></div></div>

<p>Last but not least, I need machines on my local network to know at what IP address to find https://apt-repo.servername. I’ve already set up avahi to do this for other aliases, so I just add <code class="language-plaintext highlighter-rouge">apt-repo.servername</code> to the <code class="language-plaintext highlighter-rouge">/etc/avahi/aliases</code> file, and restart <code class="language-plaintext highlighter-rouge">avahi-alias</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl restart avahi-alias
</code></pre></div></div>

<h1 id="connecting-from-the-client">Connecting from the client</h1>

<p>First, setup the root CA certificate (if you haven’t already) on the client, using <a href="/2022/04/setting-up-apt-cacher-ng-with-https/#4-install-the-root-ca-certificate-on-your-clients">the instructions from that old <code class="language-plaintext highlighter-rouge">apt-cacher-ng</code> post</a>.</p>

<p>Then follow the <a href="https://github.com/jgillula/apt-repo-manager/tree/v1.0.0#access-your-repo-remotely">instructions from <code class="language-plaintext highlighter-rouge">apt-repo-manager</code></a> to access your repo remotely.</p>

<h1 id="whats-next">What’s next</h1>

<p>Since nothing is deleting old packages from the repo on the server it’s just going to keep growing and growing. At some point I should probably adjust the <code class="language-plaintext highlighter-rouge">update-local-apt-repos.sh</code> script to delete really old packages, but hey: space is cheap and I’ve got plenty of it on my server.</p>
 
                     
 
                   </div> 
                </div>
              </div>
            </div>
            <div class="col-md-3 hidden-xs">
              
<div class="sidebar ">
  <h2>In This Post:</h2>
  <ul class="toc">
  <li><a href="#motivation">Motivation</a>
    <ul>
      <li><a href="#the-plan">The plan</a></li>
    </ul>
  </li>
  <li><a href="#syncing-with-syncthing">Syncing with Syncthing</a>
    <ul>
      <li><a href="#on-the-client">On the client</a></li>
      <li><a href="#on-the-server">On the server</a></li>
    </ul>
  </li>
  <li><a href="#turning-a-synced-folder-into-an-apt-repository">Turning a synced folder into an apt repository</a></li>
  <li><a href="#hosting-it">Hosting it</a></li>
  <li><a href="#connecting-from-the-client">Connecting from the client</a></li>
  <li><a href="#whats-next">What’s next</a></li>
</ul>
</div>


<div class="sidebar ">
  <h2>Recent Posts</h2>
  <ul>
    
    <li><a href="/2022/11/backups/">Server Backups!</a></li>
    
    <li><a href="/2022/10/hosting-your-own-apt-repo-cache/">Hosting Your Own Apt Repo Cache</a></li>
    
    <li><a href="/2022/07/getting-home-assistant-to-tell-me-when-to-open-the-windows/">Getting Home Assistant to Tell Me When to Open the Windows</a></li>
    
    <li><a href="/2022/07/updating-uncleared-home-assistant-android-notifications-with-appdaemon/">Updating Uncleared Home Assistant Android Notifications with AppDaemon</a></li>
    
    <li><a href="/2022/07/automatically-update-parameters-of-a-sleeping-z-wave-entity-in-home-assistant/">Update Parameters of a Sleeping Z-Wave Device in Home Assistant on a Schedule</a></li>
    
  </ul>
</div>

<div class="sidebar">
  <h2>Tags</h2>
  <ul class="fa-ul">
    
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/apache2" data-toggle="tooltip" data-placement="right" title="1">
        <span>apache2</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/appdaemon" data-toggle="tooltip" data-placement="right" title="1">
        <span>appdaemon</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/apt" data-toggle="tooltip" data-placement="right" title="1">
        <span>apt</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/apt-cacher-ng" data-toggle="tooltip" data-placement="right" title="1">
        <span>apt-cacher-ng</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/apt-clone" data-toggle="tooltip" data-placement="right" title="1">
        <span>apt-clone</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/automations" data-toggle="tooltip" data-placement="right" title="2">
        <span>automations</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/backups" data-toggle="tooltip" data-placement="right" title="2">
        <span>backups</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/blueprint" data-toggle="tooltip" data-placement="right" title="1">
        <span>blueprint</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/borg" data-toggle="tooltip" data-placement="right" title="1">
        <span>borg</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/borgmatic" data-toggle="tooltip" data-placement="right" title="1">
        <span>borgmatic</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/github" data-toggle="tooltip" data-placement="right" title="1">
        <span>github</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/homeassistant" data-toggle="tooltip" data-placement="right" title="3">
        <span>homeassistant</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/https" data-toggle="tooltip" data-placement="right" title="1">
        <span>https</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/jekyll" data-toggle="tooltip" data-placement="right" title="1">
        <span>jekyll</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/ruby" data-toggle="tooltip" data-placement="right" title="1">
        <span>ruby</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/scripts" data-toggle="tooltip" data-placement="right" title="1">
        <span>scripts</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/syncthing" data-toggle="tooltip" data-placement="right" title="1">
        <span>syncthing</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/timeshift" data-toggle="tooltip" data-placement="right" title="1">
        <span>timeshift</span></a></li>
    
    <li><span class="fa-li"><i class="fas fa-tag"></i></span>
            <a href="/tag/zwave" data-toggle="tooltip" data-placement="right" title="1">
        <span>zwave</span></a></li>
    
  </ul>
</div>

            </div>
          </div>
        </div>
      </div>
          <footer class="footer-distributed">
      <div class="container">
        <div class="footer">
          <p>Jeremy Gillula &copy; 2022
          <br>Theme: <a href="https://github.com/streetturtle/jekyll-clean-dark">Jekyll Clean Dark</a> with modifications</p>
        </div>
      </div>
    </footer>

    </div>
  </body>
</html>
